<!DOCTYPE html>
<html>
<head>
  <title>USD1 MLM Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/web3@1.10.0/dist/web3.min.js"></script>
  <style>
    body { font-family: Arial; padding: 20px; background: #f5f5f5; }
    .card { background: #fff; padding: 20px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 0 10px rgba(0,0,0,0.05); }
    input, button { padding: 10px; margin-top: 5px; width: 100%; font-size: 16px; margin-bottom: 10px; }
    button { background: #007bff; color: white; border: none; cursor: pointer; border-radius: 6px; }
    button:hover { background: #0056b3; }
  </style>
</head>
<body>

  <h2>USD1 MLM Dashboard (BNB Chain)</h2>
  <button id="connectBtn" onclick="connectWallet()">Connect Wallet</button>

  <div class="card">
    <p><strong>Wallet Address:</strong> <span id="wallet">Not Connected</span></p>
    <p><strong>Total Direct Referrals:</strong> <span id="directs">-</span></p>
    <p><strong>Eligible for Dividend:</strong> <span id="eligible">-</span></p>
    <p><strong>Dividend Claimed (Last Month):</strong> <span id="claimed">-</span></p>
  </div>

  <div class="card">
    <h4>Join MLM</h4>
    <input type="text" id="referrer" placeholder="Enter referrer address" />
    <button onclick="joinMLM()">Join for $20 USD1</button>
    <p>Share your referral URL: <span id="refLink"></span></p>
  </div>

  <div class="card">
    <h4>Claim Monthly Dividend</h4>
    <button onclick="claimDividend()">Claim Dividend</button>
  </div>

  <div class="card">
    <h4>10-Level Uplines</h4>
    <ol id="uplines"></ol>
  </div>

  <div class="card">
    <h4>Earnings History</h4>
    <ul id="earnings"></ul>
  </div>

  <div class="card">
    <h4>Withdraw Balance</h4>
    <button onclick="withdrawEarnings()">Withdraw</button>
  </div>

  <script>
    const CONTRACT_ADDRESS = "0xc08d415Ee020db072fDf103e3Ae3E5Bda0340440";
    const USD1_TOKEN_ADDRESS = "0x8d0D000Ee44948FC98c9B98A4FA4921476f08B0d";
    const ABI = [
      {
        "constant": false,
        "inputs": [
          {"name": "_spender", "type": "address"},
          {"name": "_value", "type": "uint256"}
        ],
        "name": "approve",
        "outputs": [{"name": "", "type": "bool"}],
        "type": "function"
      },
      {
        "constant": true,
        "inputs": [
          {"name": "_owner", "type": "address"},
          {"name": "_spender", "type": "address"}
        ],
        "name": "allowance",
        "outputs": [{"name": "", "type": "uint256"}],
        "type": "function"
      },
      {
        "inputs": [
          {"internalType": "address", "name": "recipient", "type": "address"},
          {"internalType": "uint256", "name": "amount", "type": "uint256"}
        ],
        "name": "transfer",
        "outputs": [{"internalType": "bool", "name": "", "type": "bool"}],
        "stateMutability": "nonpayable",
        "type": "function"
      },
      {
        "inputs": [
          {"internalType": "address", "name": "sender", "type": "address"},
          {"internalType": "address", "name": "recipient", "type": "address"},
          {"internalType": "uint256", "name": "amount", "type": "uint256"}
        ],
        "name": "transferFrom",
        "outputs": [{"internalType": "bool", "name": "", "type": "bool"}],
        "stateMutability": "nonpayable",
        "type": "function"
      }
    ];

    const ERC20_ABI = ABI;
    let web3, contract, token, account;

    async function connectWallet() {
      if (window.ethereum) {
        try {
          web3 = new Web3(window.ethereum);
          await window.ethereum.request({ method: 'eth_requestAccounts' });
          const accounts = await web3.eth.getAccounts();
          account = accounts[0];
          document.getElementById("wallet").innerText = account;
          document.getElementById("connectBtn").style.display = 'none';

          contract = new web3.eth.Contract(ABI, CONTRACT_ADDRESS);
          token = new web3.eth.Contract(ERC20_ABI, USD1_TOKEN_ADDRESS);

          document.getElementById("refLink").innerText = `${window.location.origin}${window.location.pathname}?ref=${account}`;

          const urlParams = new URLSearchParams(window.location.search);
          const ref = urlParams.get("ref");
          if (ref && web3.utils.isAddress(ref)) {
            document.getElementById("referrer").value = ref;
          }

          try {
            const directs = await contract.methods.getDirects(account).call();
            document.getElementById("directs").innerText = directs.length || 0;
          } catch {}

          try {
            const eligible = await contract.methods.isEligible(account).call();
            document.getElementById("eligible").innerText = eligible ? "Yes" : "No";
          } catch {}

          try {
            const month = Math.floor(Date.now() / 1000 / (30 * 24 * 60 * 60)) - 1;
            const claimed = await contract.methods.hasClaimed(account, month).call();
            document.getElementById("claimed").innerText = claimed ? "Yes" : "No";
          } catch {}

          try {
            const uplines = await contract.methods.getUplines(account).call();
            const uplist = document.getElementById("uplines");
            uplist.innerHTML = "";
            uplines.slice(0, 10).forEach((upline, i) => {
              const li = document.createElement("li");
              li.textContent = `Level ${i + 1}: ${upline}`;
              uplist.appendChild(li);
            });
          } catch {}

          try {
            const earnings = await contract.methods.getEarnings(account).call();
            const earnlist = document.getElementById("earnings");
            earnlist.innerHTML = "";
            earnings.forEach((e, i) => {
              const li = document.createElement("li");
              li.textContent = `Level ${i + 1}: $${web3.utils.fromWei(e, 'ether')}`;
              earnlist.appendChild(li);
            });
          } catch {}

        } catch (error) {
          console.error("Wallet connection failed:", error);
          alert("Failed to connect wallet. Please try again.");
        }
      } else {
        alert("Please install MetaMask to use this dApp.");
      }
    }

    window.addEventListener('load', () => {
      connectWallet();
    });

    async function joinMLM() {
      const referrer = document.getElementById("referrer").value;
      if (!web3.utils.isAddress(referrer)) {
        alert("Invalid referrer address");
        return;
      }

      try {
        const allowance = await token.methods.allowance(account, CONTRACT_ADDRESS).call();
        if (parseInt(allowance) < 20000000) {
          await token.methods.approve(CONTRACT_ADDRESS, "20000000").send({ from: account });
        }
        await contract.methods.join(referrer).send({ from: account });
        alert("Joined successfully!");
        location.reload();
      } catch (err) {
        console.error(err);
        alert("Join failed!");
      }
    }

    async function claimDividend() {
      try {
        await contract.methods.claimDividend().send({ from: account });
        alert("Dividend claimed!");
        location.reload();
      } catch (err) {
        console.error(err);
        alert("Claim failed!");
      }
    }

    async function withdrawEarnings() {
      try {
        await contract.methods.withdraw().send({ from: account });
        alert("Withdrawal successful!");
        location.reload();
      } catch (err) {
        console.error(err);
        alert("Withdrawal failed!");
      }
    }
  </script>
</body>
</html>

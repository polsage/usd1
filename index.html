<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Join USD1 MLM</title>
  <script src="https://cdn.jsdelivr.net/npm/web3@1.8.2/dist/web3.min.js"></script>
  <style>
    body { font-family: Arial; background: #f2f2f2; padding: 30px; }
    .box { background: #fff; padding: 20px; border-radius: 10px; max-width: 400px; margin: auto; }
    input, button { width: 100%; padding: 10px; margin-top: 10px; }
  </style>
</head>
<body>
  <div class="box">
    <h2>Join USD1 MLM</h2>
    <div id="wallet">Connecting...</div>
    <input type="text" id="refInput" placeholder="Referrer Address (optional)" />
    <button onclick="approveAndJoin()">Join Now ($2 USD1)</button>
    <div id="status"></div>
  </div>

  <script>
    const CONTRACT_ADDRESS = "0xd0B3F5DB3Ed55B3e7A62d23887BD9A2F49bA3f1a";
    const USD1_ADDRESS = "0x8d0D000Ee44948FC98c9B98A4FA4921476f08B0d";
    let web3, account, contract, token;

    const CONTRACT_ABI = [
      { "inputs": [{ "internalType": "address", "name": "referrer", "type": "address" }], "name": "join", "outputs": [], "stateMutability": "nonpayable", "type": "function" }
    ];

    const ERC20_ABI = [
      { "constant": true, "inputs": [{ "name": "owner", "type": "address" }, { "name": "spender", "type": "address" }], "name": "allowance", "outputs": [{ "name": "", "type": "uint256" }], "type": "function" },
      { "constant": false, "inputs": [{ "name": "spender", "type": "address" }, { "name": "value", "type": "uint256" }], "name": "approve", "outputs": [{ "name": "", "type": "bool" }], "type": "function" }
    ];

    async function connectWallet() {
      if (window.ethereum) {
        web3 = new Web3(window.ethereum);
        await window.ethereum.request({ method: 'eth_requestAccounts' });
        const accounts = await web3.eth.getAccounts();
        account = accounts[0];
        document.getElementById("wallet").innerText = `Connected: ${account}`;
        contract = new web3.eth.Contract(CONTRACT_ABI, CONTRACT_ADDRESS);
        token = new web3.eth.Contract(ERC20_ABI, USD1_ADDRESS);
      } else {
        alert("Please install MetaMask.");
      }
    }

    async function approveAndJoin() {
      const ref = document.getElementById("refInput").value || account;
      const allowance = await token.methods.allowance(account, CONTRACT_ADDRESS).call();
      const required = web3.utils.toWei("2", "ether");

      if (parseInt(allowance) < required) {
        document.getElementById("status").innerText = "Approving $2 USD1...";
        await token.methods.approve(CONTRACT_ADDRESS, required).send({ from: account });
      }

      document.getElementById("status").innerText = "Joining MLM system...";
      await contract.methods.join(ref).send({ from: account });
      document.getElementById("status").innerText = "Joined successfully!";
    }

    window.addEventListener("load", connectWallet);
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>USD1 MLM Registration</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/web3@1.8.2/dist/web3.min.js"></script>
</head>
<body class="bg-gray-100 p-4">
  <main class="max-w-md mx-auto space-y-6">

    <h1 class="text-2xl font-bold text-center">Join USD1 MLM</h1>

    <div class="bg-white p-6 rounded shadow">
      <p class="mb-2"><strong>Connected Wallet:</strong> <span id="walletAddress">Not Connected</span></p>
      <div class="flex justify-between mb-4">
        <button onclick="connectWallet()" class="bg-green-500 text-white px-4 py-2 rounded">Connect</button>
        <button onclick="disconnectWallet()" class="bg-red-500 text-white px-4 py-2 rounded">Disconnect</button>
      </div>
      <input type="text" id="referrer" placeholder="Referrer Address" class="border p-2 w-full mb-4">
      <button onclick="register()" class="bg-blue-500 text-white px-4 py-2 rounded w-full">Join System</button>
    </div>

    <p id="status" class="text-center text-green-600"></p>

  </main>

  <script>
    const CONTRACT_ADDRESS = "0x8430347c9fc22c641b8366f834540531920832be";
    const USD1_TOKEN_ADDRESS = "0x8d0D000Ee44948FC98c9B98A4FA4921476f08B0d"; // USD1 token address on BSC
    const CONTRACT_ABI = [
      {
        "constant": false,
        "inputs": [
          { "internalType": "address", "name": "referrer", "type": "address" }
        ],
        "name": "register",
        "outputs": [],
        "payable": false,
        "stateMutability": "nonpayable",
        "type": "function"
      }
    ];

    const USD1_ABI = [
      {
        "constant": false,
        "inputs": [
          { "internalType": "address", "name": "spender", "type": "address" },
          { "internalType": "uint256", "name": "amount", "type": "uint256" }
        ],
        "name": "approve",
        "outputs": [ { "internalType": "bool", "name": "", "type": "bool" } ],
        "payable": false,
        "stateMutability": "nonpayable",
        "type": "function"
      }
    ];

    let web3, account, contract, usd1;

    async function connectWallet() {
      if (window.ethereum) {
        web3 = new Web3(window.ethereum);
        await window.ethereum.request({ method: "eth_requestAccounts" });
        const accounts = await web3.eth.getAccounts();
        account = accounts[0];
        document.getElementById("walletAddress").innerText = account;
        contract = new web3.eth.Contract(CONTRACT_ABI, CONTRACT_ADDRESS);
        usd1 = new web3.eth.Contract(USD1_ABI, USD1_TOKEN_ADDRESS);
      } else {
        alert("Install MetaMask");
      }
    }

    function disconnectWallet() {
      account = null;
      document.getElementById("walletAddress").innerText = "Not Connected";
    }

    async function register() {
      document.getElementById("status").innerText = "Registering...";
      try {
        const referrer = document.getElementById("referrer").value;
        if (!web3.utils.isAddress(referrer)) {
          throw new Error("Invalid referrer address");
        }

        const registrationAmount = web3.utils.toWei("1", "ether"); // 1 USD1 = 1 * 10^18

        // Step 1: Approve contract to spend user's USD1
        await usd1.methods.approve(CONTRACT_ADDRESS, registrationAmount).send({ from: account });

        // Step 2: Call register function
        await contract.methods.register(referrer).send({ from: account });

        document.getElementById("status").innerText = "Registration successful.";
      } catch (error) {
        console.error(error);
        document.getElementById("status").innerText = "Registration failed: " + error.message;
      }
    }

    window.onload = () => {
      connectWallet();
    };
  </script>
</body>
</html>

<!DOCTYPE html>
<html>
<head>
  <title>USD1 MLM Registration</title>
  <script src="https://cdn.jsdelivr.net/npm/web3@1.8.2/dist/web3.min.js"></script>
</head>
<body>
  <h2>USD1 MLM Registration (X3 + X6)</h2>

  <p><strong>Wallet:</strong> <span id="wallet">Not Connected</span></p>
  <button onclick="connectWallet()">Connect Wallet</button><br><br>

  <label for="ref">Referrer Address:</label>
  <input type="text" id="ref" placeholder="0x..."><br><br>

  <button onclick="approve()">1. Approve USD1 (2 USD1)</button><br><br>
  <button onclick="register()">2. Register</button><br><br>

  <p>Status: <span id="status"></span></p>

  <script>
    const USD1_TOKEN_ADDRESS = "0x8d0D000Ee44948FC98c9B98A4FA4921476f08B0d"; // USD1 token address
    const MLM_CONTRACT_ADDRESS = "0x030454e152db1a861a9a41729784b62ed987b544"; // Your MLM contract

    const USD1_ABI = [
      {
        "constant": false,
        "inputs": [
          { "name": "spender", "type": "address" },
          { "name": "value", "type": "uint256" }
        ],
        "name": "approve",
        "outputs": [{ "name": "", "type": "bool" }],
        "type": "function"
      }
    ];

    const MLM_ABI = [
      {
        "constant": false,
        "inputs": [{ "name": "referrer", "type": "address" }],
        "name": "register",
        "outputs": [],
        "type": "function"
      }
    ];

    let web3;
    let account;

    async function connectWallet() {
      if (window.ethereum) {
        web3 = new Web3(window.ethereum);
        try {
          const accounts = await ethereum.request({ method: 'eth_requestAccounts' });
          account = accounts[0];
          document.getElementById("wallet").innerText = account;

          const urlParams = new URLSearchParams(window.location.search);
          const ref = urlParams.get("ref");
          if (ref && web3.utils.isAddress(ref)) {
            document.getElementById("ref").value = ref;
          }
        } catch (error) {
          document.getElementById("status").innerText = "Wallet connection failed.";
        }
      } else {
        alert("Please install MetaMask.");
      }
    }

    async function approve() {
      const usd1 = new web3.eth.Contract(USD1_ABI, USD1_TOKEN_ADDRESS);
      const amount = web3.utils.toWei("2", "ether"); // 2 USD1

      try {
        document.getElementById("status").innerText = "Approving 2 USD1...";
        await usd1.methods.approve(MLM_CONTRACT_ADDRESS, amount).send({ from: account });
        document.getElementById("status").innerText = "Approval successful.";
      } catch (e) {
        console.error(e);
        document.getElementById("status").innerText = "Approval failed.";
      }
    }

    async function register() {
      const referrer = document.getElementById("ref").value;
      if (!web3.utils.isAddress(referrer)) {
        document.getElementById("status").innerText = "Invalid referrer address.";
        return;
      }

      const mlm = new web3.eth.Contract(MLM_ABI, MLM_CONTRACT_ADDRESS);

      try {
        document.getElementById("status").innerText = "Registering...";
        await mlm.methods.register(referrer).send({ from: account });
        document.getElementById("status").innerText = "Registration successful.";
      } catch (e) {
        console.error(e);
        document.getElementById("status").innerText = "Registration failed.";
      }
    }
  </script>
</body>
</html>
